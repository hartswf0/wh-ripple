<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üé¨ Kimi K2 + LEGO Brick Film Factory</title>
    <style>
        :root {
            /* Factory Color Palette - Dark Tech Theme */
            --color-bg: #0a0a0a;
            --color-surface: #141414;
            --color-surface-light: #1e1e1e;
            --color-text: #e0e0e0;
            --color-text-secondary: #888;
            --color-primary: #ff4444; /* Director's Red */
            --color-primary-hover: #ff6666;
            --color-accent: #4a9eff; /* LEGO Blue */
            --color-accent-hover: #6ab0ff;
            --color-success: #00cc66;
            --color-warning: #ffaa00;
            --color-error: #ff4444;
            --color-focus: rgba(74, 158, 255, 0.3);
            --color-border: #333;
            --color-border-light: #444;

            --font-mono: "Courier New", "Berkeley Mono", ui-monospace, monospace;
            --font-sans: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;

            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;

            --radius: 4px;
            --shadow: 0 2px 8px rgba(0,0,0,0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-mono);
            background: var(--color-bg);
            color: var(--color-text);
            overflow: hidden;
            height: 100vh;
            font-size: 13px;
            line-height: 1.4;
        }

        #container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* ===== HEADER ===== */
        #header {
            background: linear-gradient(180deg, var(--color-surface), #121212);
            border-bottom: 2px solid var(--color-primary);
            padding: var(--space-4);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 200;
            box-shadow: var(--shadow);
        }

        #header-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .emoji {
            font-size: 20px;
            filter: drop-shadow(0 0 4px var(--color-primary));
        }

        #header-status {
            font-size: 11px;
            color: var(--color-success);
            padding: var(--space-1) var(--space-2);
            background: rgba(0,204,102,0.1);
            border-radius: var(--radius);
            border: 1px solid rgba(0,204,102,0.3);
        }

        #header-status.streaming {
            color: var(--color-warning);
            background: rgba(255,170,0,0.1);
            border-color: rgba(255,170,0,0.3);
            animation: pulse 1s infinite;
        }

        #header-status.error {
            color: var(--color-error);
            background: rgba(255,68,68,0.1);
            border-color: rgba(255,68,68,0.3);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ===== VIEWER ===== */
        #viewer-container {
            flex: 1;
            position: relative;
            background: #000;
            min-height: 300px;
        }

        #viewer-canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        #assembly-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10,10,10,0.95);
            border: 2px solid var(--color-primary);
            border-radius: var(--radius);
            padding: var(--space-4);
            min-width: 300px;
            box-shadow: var(--shadow);
            display: none;
            z-index: 150;
        }

        #assembly-overlay.active {
            display: block;
        }

        #assembly-title {
            color: var(--color-primary);
            font-weight: bold;
            margin-bottom: var(--space-2);
            text-align: center;
            font-size: 14px;
        }

        #assembly-bar {
            width: 100%;
            height: 8px;
            background: var(--color-surface-light);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: var(--space-1);
        }

        #assembly-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            width: 0%;
            transition: width 0.3s ease;
        }

        #assembly-info {
            text-align: center;
            color: var(--color-text-secondary);
            font-size: 11px;
        }

        /* ===== DIVIDER ===== */
        #divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--color-primary), transparent);
        }

        /* ===== CHAT CONTAINER ===== */
        #chat-container {
            height: 280px;
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
        }

        /* ===== TABS ===== */
        #chat-tabs {
            display: flex;
            background: var(--color-surface-light);
            border-bottom: 1px solid var(--color-border);
        }

        .chat-tab {
            flex: 1;
            padding: var(--space-2) var(--space-3);
            cursor: pointer;
            border: none;
            background: none;
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
            font-size: 12px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .chat-tab:hover {
            color: var(--color-text);
            background: rgba(255,255,255,0.05);
        }

        .chat-tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            background: rgba(255,68,68,0.1);
        }

        /* ===== OUTPUT AREA ===== */
        #chat-output {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-3);
            font-family: var(--font-mono);
            font-size: 12px;
            line-height: 1.4;
            background: var(--color-bg);
        }

        #chat-output::-webkit-scrollbar {
            width: 8px;
        }

        #chat-output::-webkit-scrollbar-track {
            background: var(--color-surface);
        }

        #chat-output::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 4px;
        }

        #chat-output::-webkit-scrollbar-thumb:hover {
            background: var(--color-border-light);
        }

        .director {
            color: var(--color-primary);
            font-weight: bold;
            margin-bottom: var(--space-2);
            text-shadow: 0 0 8px rgba(255,68,68,0.5);
        }

        .message {
            margin-bottom: var(--space-2);
            padding: var(--space-1);
            border-radius: var(--radius);
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            color: var(--color-accent);
            margin-left: var(--space-3);
            border-left: 2px solid var(--color-accent);
            padding-left: var(--space-2);
        }

        .assistant-message {
            color: var(--color-text);
        }

        .reasoning-block {
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: var(--space-2);
            margin: var(--space-2) 0;
            color: var(--color-text-secondary);
            font-size: 11px;
        }

        .reasoning-header {
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            color: var(--color-primary);
            font-weight: bold;
            margin-bottom: var(--space-1);
        }

        .reasoning-content {
            white-space: pre-wrap;
            max-height: 120px;
            overflow-y: auto;
        }

        .reasoning-content.collapsed {
            display: none;
        }

        .tool-call {
            background: var(--color-bg);
            border: 1px solid var(--color-accent);
            border-radius: var(--radius);
            padding: var(--space-2);
            margin: var(--space-2) 0;
        }

        .tool-name {
            color: var(--color-accent);
            font-weight: bold;
            margin-bottom: var(--space-1);
        }

        .tool-args {
            font-size: 11px;
            color: var(--color-text-secondary);
            font-family: var(--font-mono);
        }

        .result {
            color: var(--color-success);
            margin-left: var(--space-3);
        }

        .error {
            color: var(--color-error);
            margin-left: var(--space-3);
        }

        .scene {
            color: var(--color-accent);
            margin-left: var(--space-4);
            font-size: 11px;
        }

        /* ===== CONFIG PANEL ===== */
        #config-panel {
            display: none;
            padding: var(--space-3);
            background: var(--color-surface-light);
            border-top: 1px solid var(--color-border);
        }

        #config-panel.active {
            display: block;
        }

        .config-section {
            margin-bottom: var(--space-3);
        }

        .config-label {
            display: block;
            color: var(--color-text-secondary);
            font-size: 11px;
            margin-bottom: var(--space-1);
        }

        .config-input {
            width: 100%;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: var(--space-1);
            font-family: var(--font-mono);
            font-size: 12px;
            border-radius: var(--radius);
            margin-bottom: var(--space-2);
        }

        .config-input:focus {
            border-color: var(--color-accent);
            outline: none;
            box-shadow: 0 0 0 2px var(--color-focus);
        }

        .config-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
        }

        .warning-banner {
            background: rgba(255,170,0,0.1);
            border: 1px solid rgba(255,170,0,0.3);
            border-radius: var(--radius);
            padding: var(--space-2);
            color: var(--color-warning);
            font-size: 11px;
        }

        /* ===== INPUT AREA ===== */
        #chat-input-container {
            display: flex;
            padding: var(--space-3);
            border-top: 1px solid var(--color-border);
            background: var(--color-surface);
        }

        #chat-input {
            flex: 1;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: var(--space-2);
            font-family: var(--font-mono);
            font-size: 12px;
            outline: none;
            border-radius: var(--radius);
            transition: all 0.2s;
        }

        #chat-input:focus {
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px var(--color-focus);
        }

        #chat-send {
            background: var(--color-primary);
            border: none;
            color: var(--color-bg);
            padding: var(--space-2) var(--space-4);
            margin-left: var(--space-2);
            cursor: pointer;
            font-family: var(--font-sans);
            font-weight: bold;
            border-radius: var(--radius);
            transition: all 0.2s;
        }

        #chat-send:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }

        #chat-send:active {
            transform: translateY(0);
        }

        #chat-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== THREE.JS CANVAS ===== */
        canvas {
            display: block;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            #header-title {
                font-size: 14px;
            }
            #chat-container {
                height: 200px;
            }
            #chat-output {
                font-size: 11px;
            }
            #chat-input {
                font-size: 11px;
            }
        }
    </style>
<base target="_blank">
</head>
<body>
    <div id="container">
        <!-- HEADER -->
        <div id="header">
            <div id="header-title">
                <span class="emoji">üé¨</span> 
                Kimi K2 + LEGO Brick Film Factory
            </div>
            <div id="header-status">Ready</div>
        </div>

        <!-- VIEWER -->
        <div id="viewer-container">
            <div id="viewer-canvas"></div>
            <div id="assembly-overlay">
                <div id="assembly-title">üèóÔ∏è Building Model...</div>
                <div id="assembly-progress">
                    <div id="assembly-bar"><div id="assembly-bar-fill"></div></div>
                    <div id="assembly-info">Part 0 of 0</div>
                </div>
            </div>
        </div>

        <!-- DIVIDER -->
        <div id="divider"></div>

        <!-- CHAT -->
        <div id="chat-container">
            <div id="chat-tabs">
                <div class="chat-tab active" data-tab="console">üé¨ Director's Console</div>
                <div class="chat-tab" data-tab="config">‚öôÔ∏è AI Config</div>
            </div>

            <div id="chat-output"></div>

            <div id="config-panel">
                <div class="config-section">
                    <label class="config-label">Moonshot API Key:</label>
                    <input type="password" id="apiKey" class="config-input" placeholder="sk-..." autocomplete="off">
                </div>
                <div class="config-section">
                    <label class="config-label">Model & Settings:</label>
                    <div class="config-row">
                        <select id="model" class="config-input">
                            <option value="moonshot-v1-k2-thinking">moonshot-v1-k2-thinking (Reasoning)</option>
                            <option value="moonshot-v1-128k">moonshot-v1-128k (Standard)</option>
                            <option value="moonshot-v1-32k">moonshot-v1-32k (Fast)</option>
                            <option value="moonshot-v1-8k">moonshot-v1-8k (Turbo)</option>
                        </select>
                        <input type="number" id="maxTokens" class="config-input" value="16000" min="1000" max="32000" placeholder="Tokens">
                        <input type="number" id="temperature" class="config-input" value="1.0" min="0" max="2" step="0.1" placeholder="Temp">
                    </div>
                </div>
                <div class="warning-banner">
                    <strong>‚ö†Ô∏è API Key stored only in memory!</strong>
                </div>
            </div>

            <div id="controls-panel"></div>

            <div id="chat-input-container">
                <input type="text" id="chat-input" placeholder="Director's command... (try: 'animate the X-Wing')" autocomplete="off">
                <button id="chat-send">‚ñ∂ Send</button>
            </div>
        </div>
    </div>

    <!-- THREE.JS -->
    <script src="./build/three.js"></script>
    <script src="./examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="./examples/js/loaders/LDrawLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/GLTFExporter.js"></script>
    <script src="./examples/js/libs/dat.gui.min.js"></script>
    
    <!-- LDraw Extensions - REMOVE ldraw-ai-extension.js to avoid conflicts -->
    <!-- <script defer src="./ldraw-ai-extension.js"></script> -->
    <script defer src="./ldraw-metadata-extension.js"></script>
    <script defer src="./ldraw-custom-commands.js"></script>
    <script defer src="./ldraw-omr-extension.js"></script>
    <script defer src="./ldraw-header-compliance.js"></script>
    <script defer src="./ldraw-individual-renderer.js"></script>
    <script defer src="./ldraw-standard-individual.js"></script>
    <script defer src="./ldraw-geometry-explorer.js"></script>
    <script defer src="./ldraw-separate-objects.js"></script>

    <script>
        // ============================================
        // APPLICATION STATE
        // ============================================
        const appState = {
            messages: [],
            apiKey: '',
            totalTokens: 0,
            isStreaming: false,
            toolCalls: [],
            config: {
                model: 'kimi-k2-thinking',
                maxTokens: 16000,
                temperature: 1.0
            }
        };

        // DOM Elements
        const elements = {
            headerStatus: document.getElementById('header-status'),
            viewerCanvas: document.getElementById('viewer-canvas'),
            assemblyOverlay: document.getElementById('assembly-overlay'),
            assemblyBarFill: document.getElementById('assembly-bar-fill'),
            assemblyInfo: document.getElementById('assembly-info'),
            chatOutput: document.getElementById('chat-output'),
            chatInput: document.getElementById('chat-input'),
            chatSend: document.getElementById('chat-send'),
            apiKey: document.getElementById('apiKey'),
            model: document.getElementById('model'),
            maxTokens: document.getElementById('maxTokens'),
            temperature: document.getElementById('temperature'),
            configPanel: document.getElementById('config-panel'),
            tabs: document.querySelectorAll('.chat-tab')
        };

        // ============================================
        // LDraw Builder
        // ============================================
        const LDRAW_STATE = {
            basePath: './examples/models/ldraw/officialLibrary/',
            camera: null,
            scene: null,
            renderer: null,
            controls: null,
            pointLight: null,
            model: null,
            materials: [],
            parts: [],
            explodeFactor: 0,
            currentModelName: null,
            modelList: {
                'Car': { path: 'models/car.ldr_Packed.mpd', separate: true },
                'X-Wing': { path: 'models/7140-1-X-wingFighter.mpd_Packed.mpd', separate: true },
                'AT-ST': { path: 'models/10174-1-ImperialAT-ST-UCS.mpd_Packed.mpd', separate: true },
                'Lunar Vehicle': { path: 'models/1621-1-LunarMPVVehicle.mpd_Packed.mpd', separate: true },
                'Bulldozer': { path: 'models/4915-1-MiniConstruction.mpd_Packed.mpd', separate: true },
                'Helicopter': { path: 'models/4918-1-MiniFlyers.mpd_Packed.mpd', separate: true },
                'Empty': null
            }
        };

        function chatLog(message, type = 'result') {
            const div = document.createElement('div');
            div.className = type;
            
            switch(type) {
                case 'director':
                    div.innerHTML = `<div class="director">${message}</div>`;
                    break;
                case 'user':
                    div.innerHTML = `<div class="user-message">${message}</div>`;
                    break;
                case 'scene':
                    div.innerHTML = `<div class="scene">${message}</div>`;
                    break;
                case 'error':
                    div.innerHTML = `<div class="error">${message}</div>`;
                    break;
                default:
                    div.innerHTML = `<div class="${type}">${message}</div>`;
            }
            
            elements.chatOutput.appendChild(div);
            elements.chatOutput.scrollTop = elements.chatOutput.scrollHeight;
        }

        function showAssemblyProgress(current, total) {
            if (total === 0) {
                elements.assemblyOverlay.classList.remove('active');
                return;
            }
            
            elements.assemblyOverlay.classList.add('active');
            const percent = (current / total) * 100;
            elements.assemblyBarFill.style.width = percent + '%';
            elements.assemblyInfo.textContent = `Part ${current} of ${total}`;
        }

        // ============================================
        // THREE.JS Viewer
        // ============================================
        function initViewer() {
            // Renderer
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setSize(elements.viewerCanvas.offsetWidth, elements.viewerCanvas.offsetHeight);
            renderer.setClearColor(0x000000, 1);
            elements.viewerCanvas.appendChild(renderer.domElement);

            // Camera
            const camera = new THREE.PerspectiveCamera(
                45,
                elements.viewerCanvas.offsetWidth / elements.viewerCanvas.offsetHeight,
                1,
                10000
            );
            camera.position.set(150, 200, 250);

            // Scene
            const scene = new THREE.Scene();

            const ambientLight = new THREE.AmbientLight(0xcccccc, 0.4);
            scene.add(ambientLight);

            const pointLight = new THREE.PointLight(0xffffff, 1);
            pointLight.position.set(-1000, 1200, 1500);
            scene.add(pointLight);

            // Controls
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // Store in state
            LDRAW_STATE.renderer = renderer;
            LDRAW_STATE.camera = camera;
            LDRAW_STATE.scene = scene;
            LDRAW_STATE.controls = controls;
            LDRAW_STATE.pointLight = pointLight;

            // Handle resize
            window.addEventListener('resize', () => {
                camera.aspect = elements.viewerCanvas.offsetWidth / elements.viewerCanvas.offsetHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(elements.viewerCanvas.offsetWidth, elements.viewerCanvas.offsetHeight);
            });

            // Start render loop
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (LDRAW_STATE.controls) LDRAW_STATE.controls.update();
            if (LDRAW_STATE.renderer && LDRAW_STATE.scene && LDRAW_STATE.camera) {
                LDRAW_STATE.renderer.render(LDRAW_STATE.scene, LDRAW_STATE.camera);
            }
        }

        // ============================================
        // AI Tool Definitions
        // ============================================
        const TOOLS = [
            {
                type: "function",
                function: {
                    name: "load_model",
                    description: "Load a LEGO model by name (Car, X-Wing, AT-ST, etc.)",
                    parameters: {
                        type: "object",
                        properties: {
                            name: { type: "string", description: "Model name from the curated list" }
                        },
                        required: ["name"]
                    }
                }
            },
            {
                type: "function",
                function: {
                    name: "animate_assembly",
                    description: "Animate brick-by-brick assembly of the current model",
                    parameters: {
                        type: "object",
                        properties: {
                            speed: { type: "number", minimum: 0.5, maximum: 5, default: 1, description: "Animation speed multiplier" }
                        }
                    }
                }
            },
            {
                type: "function",
                function: {
                    name: "set_explode",
                    description: "Explode model parts apart for better visibility",
                    parameters: {
                        type: "object",
                        properties: {
                            factor: { type: "number", minimum: 0, maximum: 1, description: "Explosion factor from 0 (normal) to 1 (fully exploded)" }
                        },
                        required: ["factor"]
                    }
                }
            },
            {
                type: "function",
                function: {
                    name: "clear_scene",
                    description: "Clear the current model from the scene",
                    parameters: { type: "object", properties: {} }
                }
            },
            {
                type: "function",
                function: {
                    name: "hide_part",
                    description: "Hide a specific part by index",
                    parameters: {
                        type: "object",
                        properties: {
                            index: { type: "integer", minimum: 1, description: "Part index to hide (1-based)" }
                        },
                        required: ["index"]
                    }
                }
            },
            {
                type: "function",
                function: {
                    name: "show_part",
                    description: "Show a specific part by index",
                    parameters: {
                        type: "object",
                        properties: {
                            index: { type: "integer", minimum: 1, description: "Part index to show (1-based)" }
                        },
                        required: ["index"]
                    }
                }
            },
            {
                type: "function",
                function: {
                    name: "list_parts",
                    description: "List all parts in the current model",
                    parameters: { type: "object", properties: {} }
                }
            }
        ];

        // ============================================
        // Tool Executors
        // ============================================
        const TOOL_EXECUTORS = {
            load_model: async (args) => {
                const modelName = args.name;
                const modelData = LDRAW_STATE.modelList[modelName];
                
                if (modelData === undefined) {
                    const available = Object.keys(LDRAW_STATE.modelList).filter(k => LDRAW_STATE.modelList[k] !== null).join(', ');
                    return `Error: Model "${modelName}" not found. Available: ${available}`;
                }
                
                if (modelName === 'Empty') {
                    return await TOOL_EXECUTORS.clear_scene();
                }

                LDRAW_STATE.currentModelName = modelName;
                chatLog(`üìÇ Loading ${modelName}...`, 'scene');
                
                const loader = new THREE.LDrawLoader();
                loader.setPath(LDRAW_STATE.basePath);
                
                return new Promise((resolve, reject) => {
                    loader.load(
                        modelData.path,
                        (group) => {
                            if (LDRAW_STATE.model) {
                                LDRAW_STATE.scene.remove(LDRAW_STATE.model);
                            }

                            LDRAW_STATE.model = group;
                            LDRAW_STATE.model.rotation.x = Math.PI;
                            LDRAW_STATE.scene.add(LDRAW_STATE.model);

                            // Extract parts
                            LDRAW_STATE.parts = [];
                            LDRAW_STATE.model.traverse((child) => {
                                if (child.isMesh) {
                                    LDRAW_STATE.parts.push(child);
                                    child.userData.originalPosition = child.position.clone();
                                }
                            });

                            chatLog(`‚úÖ Loaded ${modelName} (${LDRAW_STATE.parts.length} parts)`, 'result');
                            
                            // Fit camera
                            const bbox = new THREE.Box3().setFromObject(LDRAW_STATE.model);
                            const center = bbox.getCenter(new THREE.Vector3());
                            const size = bbox.getSize(new THREE.Vector3());
                            const radius = Math.max(size.x, size.y, size.z) * 0.5;
                            
                            LDRAW_STATE.camera.position.set(-2.3, 2, 2).multiplyScalar(radius).add(center);
                            LDRAW_STATE.controls.target.copy(center);
                            LDRAW_STATE.controls.update();
                            
                            resolve(`‚úÖ Successfully loaded ${modelName} with ${LDRAW_STATE.parts.length} parts`);
                        },
                        (xhr) => {
                            if (xhr.lengthComputable) {
                                const percent = Math.round((xhr.loaded / xhr.total) * 100);
                                showAssemblyProgress(0, 0);
                            }
                        },
                        (error) => {
                            reject(`‚ùå Failed to load: ${error.message}`);
                        }
                    );
                });
            },

            animate_assembly: async (args) => {
                if (!LDRAW_STATE.parts || LDRAW_STATE.parts.length === 0) {
                    return 'Error: No model loaded to animate';
                }

                const speed = args.speed || 1;
                const totalParts = LDRAW_STATE.parts.length;
                
                chatLog(`üé¨ Starting assembly animation (${totalParts} parts at ${speed}x speed)...`, 'director');
                
                // Hide all parts initially
                LDRAW_STATE.parts.forEach(part => part.visible = false);
                
                // Animate sequentially
                for (let i = 0; i < totalParts; i++) {
                    LDRAW_STATE.parts[i].visible = true;
                    showAssemblyProgress(i + 1, totalParts);
                    
                    if (i % 5 === 0 || i === totalParts - 1) {
                        chatLog(`  üì¶ Part ${i + 1}/${totalParts} placed`, 'scene');
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1000 / speed));
                }
                
                showAssemblyProgress(0, 0);
                chatLog('‚úÖ Assembly complete!', 'result');
                return `‚úÖ Assembly animation finished at ${speed}x speed`;
            },

            set_explode: async (args) => {
                if (!LDRAW_STATE.model) return 'Error: No model loaded';
                
                const factor = args.factor;
                LDRAW_STATE.explodeFactor = factor;
                
                const bbox = new THREE.Box3().setFromObject(LDRAW_STATE.model);
                const center = bbox.getCenter(new THREE.Vector3());
                
                LDRAW_STATE.model.traverse((child) => {
                    if (child.isMesh && child.userData.originalPosition) {
                        const dir = child.userData.originalPosition.clone().sub(center).normalize();
                        const offset = dir.multiplyScalar(factor * 200);
                        child.position.copy(child.userData.originalPosition).add(offset);
                    }
                });
                
                chatLog(`üí• Exploded model with factor ${factor}`, 'scene');
                return `‚úÖ Model exploded with factor ${factor}`;
            },

            clear_scene: async () => {
                if (LDRAW_STATE.model) {
                    LDRAW_STATE.scene.remove(LDRAW_STATE.model);
                    LDRAW_STATE.model = null;
                    LDRAW_STATE.parts = [];
                    LDRAW_STATE.currentModelName = null;
                    showAssemblyProgress(0, 0);
                    chatLog('üóëÔ∏è Scene cleared', 'result');
                    return '‚úÖ Scene cleared';
                }
                return 'Scene already empty';
            },

            hide_part: async (args) => {
                const index = args.index - 1;
                if (index < 0 || index >= LDRAW_STATE.parts.length) {
                    return `Error: Invalid part index. Must be 1-${LDRAW_STATE.parts.length}`;
                }
                LDRAW_STATE.parts[index].visible = false;
                return `‚úÖ Hidden part ${args.index}`;
            },

            show_part: async (args) => {
                const index = args.index - 1;
                if (index < 0 || index >= LDRAW_STATE.parts.length) {
                    return `Error: Invalid part index. Must be 1-${LDRAW_STATE.parts.length}`;
                }
                LDRAW_STATE.parts[index].visible = true;
                return `‚úÖ Showed part ${args.index}`;
            },

            list_parts: async () => {
                if (!LDRAW_STATE.parts || LDRAW_STATE.parts.length === 0) {
                    return 'Error: No model loaded';
                }
                
                const partsList = LDRAW_STATE.parts.map((part, i) => {
                    const color = part.material?.color ? '#' + part.material.color.getHexString() : 'unknown';
                    return `${i + 1}. ${part.name || 'Part'} - Color: ${color}`;
                }).join('\n');
                
                chatLog(`üìã PARTS LIST (${LDRAW_STATE.parts.length} total):\n${partsList}`, 'result');
                return `‚úÖ Listed ${LDRAW_STATE.parts.length} parts`;
            }
        };

        // ============================================
        // AI Chat Integration
        // ============================================
        async function sendMessage() {
            const message = elements.chatInput.value.trim();
            if (!message) return;

            // Validate API key
            if (!elements.apiKey.value) {
                chatLog('‚ùå Please enter your Moonshot API key in the Config tab', 'error');
                elements.headerStatus.textContent = 'API Key Required';
                elements.headerStatus.classList.add('error');
                return;
            }

            // Add user message
            chatLog(`> ${message}`, 'user');
            elements.chatInput.value = '';

            // Update status
            elements.headerStatus.textContent = 'Thinking...';
            elements.headerStatus.classList.add('streaming');
            elements.headerStatus.classList.remove('error');

            // Build messages for API
            const messages = [
                {
                    role: 'system',
                    content: `You are the DIRECTOR of a LEGO Brick Film Factory. You have these tools:
- load_model(name): Load LEGO models (Car, X-Wing, AT-ST, etc.)
- animate_assembly(speed): Show brick-by-brick assembly
- set_explode(factor): Spread parts apart (0-1)
- hide_part(index), show_part(index): Control individual parts
- list_parts(): Show all parts in model
- clear_scene(): Clear the scene

Think step-by-step about what the user wants, then use tools. Show your reasoning process in the "Director's Thoughts" section.`
                },
                ...appState.messages.map(m => ({
                    role: m.role,
                    content: m.content,
                    ...(m.tool_calls && { tool_calls: m.tool_calls }),
                    ...(m.tool_call_id && { tool_call_id: m.tool_call_id, name: m.name })
                })),
                { role: 'user', content: message }
            ];

            try {
                const response = await fetch('https://api.moonshot.cn/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${elements.apiKey.value}`
                    },
                    body: JSON.stringify({
                        model: elements.model.value,
                        messages: messages,
                        max_tokens: parseInt(elements.maxTokens.value),
                        temperature: parseFloat(elements.temperature.value),
                        stream: true,
                        tools: TOOLS,
                        tool_choice: "auto"
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Invalid API key - please check your Moonshot API key');
                    }
                    throw new Error(`API Error ${response.status}: ${response.statusText}`);
                }

                await processStream(response.body);
                
            } catch (error) {
                console.error('Chat error:', error);
                chatLog(`‚ùå ${error.message}`, 'error');
                elements.headerStatus.textContent = 'Error';
                elements.headerStatus.classList.add('error');
            } finally {
                elements.headerStatus.textContent = 'Ready';
                elements.headerStatus.classList.remove('streaming');
            }
        }

        async function processStream(stream) {
            const reader = stream.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            let currentMessage = {
                role: 'assistant',
                content: '',
                reasoning_content: '',
                tool_calls: []
            };

            // Clear previous display elements
            let currentReasoningDiv = null;
            let currentAssistantDiv = null;
            let currentToolDiv = null;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (!line.trim() || line.startsWith(':')) continue;

                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (data === '[DONE]') continue;

                        try {
                            const parsed = JSON.parse(data);
                            const delta = parsed.choices?.[0]?.delta;
                            const usage = parsed.usage;

                            if (!delta) continue;

                            // Handle reasoning
                            if (delta.reasoning_content) {
                                currentMessage.reasoning_content += delta.reasoning_content;
                                if (!currentReasoningDiv) {
                                    currentReasoningDiv = document.createElement('div');
                                    currentReasoningDiv.className = 'reasoning-block';
                                    currentReasoningDiv.innerHTML = `
                                        <div class="reasoning-header">
                                            <span>üß† Director's Thoughts</span>
                                            <span>‚ñº</span>
                                        </div>
                                        <div class="reasoning-content"></div>
                                    `;
                                    elements.chatOutput.appendChild(currentReasoningDiv);
                                    
                                    // Add toggle
                                    currentReasoningDiv.querySelector('.reasoning-header').addEventListener('click', () => {
                                        const content = currentReasoningDiv.querySelector('.reasoning-content');
                                        content.classList.toggle('collapsed');
                                    });
                                }
                                currentReasoningDiv.querySelector('.reasoning-content').textContent = currentMessage.reasoning_content;
                                elements.chatOutput.scrollTop = elements.chatOutput.scrollHeight;
                            }

                            // Handle main content
                            if (delta.content) {
                                currentMessage.content += delta.content;
                                if (!currentAssistantDiv) {
                                    currentAssistantDiv = document.createElement('div');
                                    currentAssistantDiv.className = 'message assistant-message';
                                    elements.chatOutput.appendChild(currentAssistantDiv);
                                }
                                currentAssistantDiv.textContent = currentMessage.content;
                                elements.chatOutput.scrollTop = elements.chatOutput.scrollHeight;
                            }

                            // Handle tool calls
                            if (delta.tool_calls) {
                                for (const toolCall of delta.tool_calls) {
                                    const index = toolCall.index;
                                    if (!currentMessage.tool_calls[index]) {
                                        currentMessage.tool_calls[index] = {
                                            id: toolCall.id || '',
                                            function: { name: '', arguments: '' }
                                        };
                                    }
                                    if (toolCall.function?.name) {
                                        currentMessage.tool_calls[index].function.name = toolCall.function.name;
                                    }
                                    if (toolCall.function?.arguments) {
                                        currentMessage.tool_calls[index].function.arguments += toolCall.function.arguments;
                                    }

                                    // Display tool call
                                    if (!currentToolDiv) {
                                        currentToolDiv = document.createElement('div');
                                        currentToolDiv.className = 'tool-call';
                                        elements.chatOutput.appendChild(currentToolDiv);
                                    }
                                    
                                    const args = currentMessage.tool_calls[index].function.arguments || '{}';
                                    let argsStr = args;
                                    try {
                                        argsStr = JSON.stringify(JSON.parse(args), null, 2);
                                    } catch (e) {}
                                    
                                    currentToolDiv.innerHTML = `
                                        <div class="tool-name">üîß ${currentMessage.tool_calls[index].function.name}</div>
                                        <div class="tool-args">${argsStr}</div>
                                    `;
                                    elements.chatOutput.scrollTop = elements.chatOutput.scrollHeight;
                                }
                            }

                            // Update token usage
                            if (usage) {
                                appState.totalTokens = usage.total_tokens || appState.totalTokens;
                            }

                        } catch (e) {
                            console.error('Parse error:', e, line);
                        }
                    }
                }
            }

            // Execute tool calls
            if (currentMessage.tool_calls.length > 0) {
                for (const toolCall of currentMessage.tool_calls) {
                    if (!toolCall.function?.name) continue;
                    
                    try {
                        chatLog(`üîß Executing tool: ${toolCall.function.name}`, 'scene');
                        const args = JSON.parse(toolCall.function.arguments || '{}');
                        const result = await TOOL_EXECUTORS[toolCall.function.name](args);
                        chatLog(result, 'result');
                    } catch (error) {
                        chatLog(`‚ùå Tool error: ${error.message}`, 'error');
                    }
                }
            }

            // Save message to history
            appState.messages.push(currentMessage);
        }

        // ============================================
        // Event Listeners
        // ============================================
        elements.chatSend.addEventListener('click', sendMessage);
        elements.chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Tab switching
        elements.tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                
                elements.tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                if (target === 'config') {
                    elements.configPanel.classList.add('active');
                } else {
                    elements.configPanel.classList.remove('active');
                }
            });
        });

        // Auto-focus input
        elements.chatInput.focus();

        // Update config
        elements.apiKey.addEventListener('input', (e) => {
            appState.apiKey = e.target.value;
            if (e.target.value) {
                elements.headerStatus.classList.remove('error');
                elements.headerStatus.textContent = 'Ready';
            }
        });

        // ============================================
        // Initialize
        // ============================================
        function init() {
            initViewer();
            chatLog('üé¨ LEGO Brick Film Factory - Director\'s Console', 'director');
            chatLog('üí° Try: "Load the X-Wing and animate it"', 'result');
            chatLog('üí° Or: "Show me the simplest model"', 'result');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>